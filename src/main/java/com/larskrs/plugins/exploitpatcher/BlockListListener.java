package com.larskrs.plugins.exploitpatcher;

import com.larskrs.plugins.exploitpatcher.tools.XMaterial;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.World;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Entity;
import org.bukkit.entity.LivingEntity;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;

import java.util.List;

public class BlockListListener implements Listener {

    private ExploitPatcher exploitPatcher;


    public BlockListListener(ExploitPatcher exploitPatcher) {
        this.exploitPatcher = exploitPatcher;
    }
    @EventHandler
    public void onClick(InventoryClickEvent e) {

        Player p = (Player) e.getWhoClicked();
        ItemStack item = e.getCurrentItem();
        Inventory inv = e.getInventory();

        if (item != null && item.getType() != null && e.getView().getTitle().contains("Block") && item.getItemMeta() != null) {
            int page = EntityListMenu.Page;
            int newpage = page;


            if (e.getRawSlot() == 45 && item.getType().equals(XMaterial.ARROW.parseMaterial())) {
                //Left Button
                new EntityListMenu(p, page - 1);
                newpage --;
            } else if (e.getRawSlot() == 53 && item.getType().equals(XMaterial.ARROW.parseMaterial())) {
                // Right Button
                new EntityListMenu(p, page + 1);
                newpage ++;
            } else if (e.getRawSlot() == 49 && item.getType().equals(XMaterial.BUCKET.parseMaterial())) {
                // Clear Blocked
                removeBannedEntities(p);

            } else if (e.getRawSlot() != 45 && e.getRawSlot() != 53) {
                String name = item.getItemMeta().getDisplayName();

                if (exploitPatcher.getConfig().getStringList("blocked-blocks").contains(name)) {
                    config.unbanEntity(name);
                } else {
                    config.banEntity(name);
                }
            }


            e.setCancelled(true);

            // reOpen the inventory

            new BlockListMenu(p, newpage);
        }
    }
    public void removeBannedEntities(Player p) {

        FileConfiguration confg = exploitPatcher.getConfig();

        List<String> blocked = confg.getStringList("blocked-entities");
        int killed = 0;
        for (World w : Bukkit.getServer().getWorlds()) {
            for (Entity e : w.getEntities()) {
                if (e instanceof LivingEntity && blocked.contains(e.getType().name())) {
                    LivingEntity el = (LivingEntity) e;
                    el.damage(el.getHealth());


                    killed++;
                }
            }
        }
        p.sendMessage(ChatColor.translateAlternateColorCodes('&', "&fRemoved: "+ killed + " entities."));

    }
}
